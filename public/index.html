<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css" rel="stylesheet" />
    <link href="stylesheets/main.css" type="text/css" rel="stylesheet" />

    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.js"></script>
    <script type="text/javascript" src="javascripts/jquery.touchSwipe.js"></script>
    <script type="text/javascript" src="/javascripts/modernizr-sockets-touchevents.js"></script>
    <script type="text/javascript" src="javascripts/main.js"></script>

 
  </head>
  <body>

    <script type="text/javascript">
    
      var socketUrl = 'http://' + location.hostname + ':80';
      var isMobileDevice = Modernizr.touch;
      var socket = io.connect(socketUrl);

      socket.on('connecting', function () {
        console.log('Setting Up connection');
      });

      socket.on('error', function () {
        console.log('error');
      });
    
      // Check Device Type
      socket.on('checkDevice', function () {
        console.log("connected!");
        // Using modernizr feature detection for mobile touch events
        if(isMobileDevice){
          isTouchable();
        } else{
          isNotTouchable();
        }
      }); // main check


      var isTouchable = function(){
        var sessionHash = prompt('Please enter the code:');
        socket.emit('initiateController', {sessionHash: sessionHash});
        socket.on('controllerAuthorization', function (data) {
          if(data){
            alert('Authorized');
            var sessionHash = data;
            // Touchable jQuery 
            $(function() {      
              $("#controllerPad").swipe( {

                swipeStatus:function(event, phase, direction, distance , duration , fingerCount) {
                   $(this).find('#statusBox').text("swiped " + distance + ' px');
                   if(phase === $.fn.swipe.phases.PHASE_END || phase === $.fn.swipe.phases.PHASE_CANCEL) {
                      // no swipe
                    } else{
                        socket.emit('swipeStatus', {"distance" : distance, "sessionHash": sessionHash});
                    }
                   
                },

                pinchStatus:function(event, phase, direction, distance , duration , fingerCount, pinchZoom) {
                  $(this).find('#statusBox').text("pinched " + distance + " px ");
                  if(phase === $.fn.swipe.phases.PHASE_END || phase === $.fn.swipe.phases.PHASE_CANCEL) {
                      // no pinch
                  } else{
                      socket.emit('pinchStatus', {"distance" : distance, "sessionHash": sessionHash});
                  }
                  
                },

                swipe:function(event, direction, distance, duration, fingerCount) {
                   $(this).find('#statusBox').text("You swiped " + direction + " with " + fingerCount + " fingers");
                   socket.emit('swipe', {"direction" : direction, "fingerCount":fingerCount, "distance":distance, "duration":duration, "sessionHash": sessionHash});
                },

                pinchIn:function(event, direction, distance, duration, fingerCount, pinchZoom) {
                  $(this).find('#statusBox').text("You pinched " +direction + " by " + distance +"px, zoom scale is "+pinchZoom);
                  socket.emit('pinchIn', {"direction" : direction, "distance": distance, "zoomScale": pinchZoom});
                },

                pinchOut:function(event, direction, distance, duration, fingerCount, pinchZoom) {
                  $(this).find('#statusBox').text("You pinched " +direction + " by " + distance +"px, zoom scale is "+pinchZoom);
                  socket.emit('pinchOut', {"direction" : direction, "distance": distance, "zoomScale": pinchZoom});
                },

                fingers:$.fn.swipe.fingers.ALL  
              });
            }); // Touchable jQuery 
          } else{
            socket.disconnect();
            alert('You have been disconnected. Wrong Key');
          }
        });

      } // is Mobile 
      var isNotTouchable = function() {
        console.log('DESKTOP');
      } // is Desktop 

    </script>

    <div class="container">
      <div id="controllerPad" class="box">Swipe me with different combinations of fingers</div>
      <div id="statusBox">
        <p>Two Finger swipe Up / Down = Move in direction the amount of swiped pixels</p>
        <p>Three Finger swipe Up / Down = Move to top / bottom of page depending on swipe direction</p>
      </div>
    </div>

  </body>
</html>